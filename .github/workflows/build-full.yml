name: Build Ollama (CUDA + Vulkan - Bypass Network Error)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 【必须】强力清理磁盘
      # GitHub 免费空间只有 14GB，不清理装不下 CUDA+Vulkan
      - name: Free Disk Space (Manual)
        run: |
          echo "清理前空间："
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "清理后空间："
          df -h

      # 2. 拉取官方代码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【关键】修改 Dockerfile 绕过网络错误
      # 逻辑：官方 Dockerfile 的 rocm 阶段依赖的源在 GitHub 上连不通。
      # 我们保留 CUDA，只把 rocm 相关的 COPY 注释掉。
      # 这样 Docker 就不会去构建 rocm 阶段，自然就不会报错了。
      - name: Patch Dockerfile
        run: |
          echo "正在修改 Dockerfile..."
          
          # 1. 使用 sed 正则表达式，注释掉所有从 rocm 阶段复制文件的行
          # 无论是 COPY --from=rocm 还是 COPY --from=rocm-6 都会被注释
          sed -i 's/^COPY --from=rocm/# COPY --from=rocm/' Dockerfile
          
          # 2. 强制添加 Vulkan 环境变量 (为了你的 AMD 核显)
          sed -i '/FROM ubuntu:24.04 AS default/a ENV OLLAMA_VULKAN=1' Dockerfile
          
          echo "=== 验证：CUDA 依然保留 ==="
          grep "COPY --from=cuda" Dockerfile
          
          echo "=== 验证：ROCm 已被注释 ==="
          grep "COPY --from=rocm" Dockerfile

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          # 必须禁用 GHA 缓存导出，否则会把硬盘撑爆导致失败
          no-cache: false
