name: Build Ollama (Rebuild Foundation)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 清理磁盘 (必须保留)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取官方代码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【核心修复】替换掉坏掉的地基命令
      # 使用 Python 精准替换，不依赖 fragile 的 sed
      - name: Fix Dockerfile Foundation
        shell: python
        run: |
          import re
          
          print("正在读取 Dockerfile...")
          with open("Dockerfile", "r") as f:
              content = f.read()
          
          # 1. 定义那个报错的 RUN 命令块的特征
          # 它试图添加 rockylinux.org 的源，这在 GitHub 上是连不通的
          # 我们用正则找到从 "RUN yum install" 开始到 "cuda-rhel8.repo" 结束的一大段
          bad_run_block = re.compile(r"RUN yum install.*?cuda-rhel8\.repo", re.DOTALL)
          
          # 2. 定义一个新的、健康的命令块
          # 我们直接从系统默认源安装 gcc-toolset-10，不去连那个坏掉的 Rocky Vault
          # 并且只添加 NVIDIA 的源（这是通的）
          good_run_block = """RUN dnf install -y 'dnf-command(config-manager)' \\
              && dnf install -y gcc-toolset-10 git make \\
              && dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo"""
          
          # 3. 执行替换
          if bad_run_block.search(content):
              print("✅ 找到了报错的构建命令，正在替换为修复版...")
              new_content = bad_run_block.sub(good_run_block, content)
              
              # 4. 顺便注入 Vulkan 环境变量
              new_content = new_content.replace("FROM ubuntu:24.04 AS default", "FROM ubuntu:24.04 AS default\nENV OLLAMA_VULKAN=1")
              
              with open("Dockerfile", "w") as f:
                  f.write(new_content)
              print("Dockerfile 地基修复完成！")
          else:
              print("❌ 严重错误：没找到预期的 RUN 命令，官方 Dockerfile 可能改了结构。")
              print("当前文件内容前 20 行：")
              print(content[:1000])
              exit(1)

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: false
