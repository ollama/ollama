name: Build Ollama (Clean Base Fix)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 强力清理磁盘 (必须)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取官方代码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【核心修复】Python 脚本重构 Dockerfile
      # 逻辑：
      # 1. 替换基础镜像：把坏掉的 rocm/dev-almalinux-8 换成 almalinux:8 (纯净官方版)
      # 2. 注入依赖：手动安装 gcc-toolset-10, wget, git, cmake (补全缺失工具)
      # 3. 添加 NVIDIA 源：保证 CUDA 能正常编译
      # 4. 强制 Vulkan：保证你的核显能用
      - name: Patch Dockerfile with Python
        shell: python
        run: |
          import re
          
          print(">>> Reading Dockerfile...")
          with open("Dockerfile", "r") as f:
              content = f.read()
          
          # === 步骤 1: 替换基础镜像 ===
          # 将报错的 rocm 镜像换成官方 almalinux:8
          content = re.sub(
              r"FROM --platform=linux/amd64 rocm/dev-almalinux-8.*? AS base-amd64",
              "FROM --platform=linux/amd64 almalinux:8 AS base-amd64",
              content
          )
          
          # === 步骤 2: 重写 RUN 命令 (补全工具 + 修复源) ===
          # 上次报错是因为缺 wget/tar，这次我们全部补齐
          new_run_cmd = """RUN dnf install -y 'dnf-command(config-manager)' epel-release \\
              && dnf config-manager --set-enabled appstream \\
              && dnf install -y gcc-toolset-10 git make wget tar xz cmake \\
              && dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo \\
              && dnf clean all"""
          
          # 使用正则替换掉那个巨长的、报错的 yum install 命令
          content = re.sub(
              r"RUN yum install.*?cuda-rhel8\.repo", 
              new_run_cmd, 
              content, 
              flags=re.DOTALL
          )
          
          # === 步骤 3: 强制开启 Vulkan ===
          if "ENV OLLAMA_VULKAN=1" not in content:
              content = content.replace("FROM ubuntu:24.04 AS default", "FROM ubuntu:24.04 AS default\nENV OLLAMA_VULKAN=1")

          # === 步骤 4: 屏蔽 ROCm 阶段的 COPY ===
          # 虽然换了 base 镜像，但我们没有手动编译 ROCm 库，所以 COPY --from=rocm 会失败
          # 必须把它们注释掉，反正你不用 AMD 独显
          lines = content.splitlines()
          final_lines = []
          for line in lines:
              if "COPY --from=rocm" in line:
                  final_lines.append(f"# {line}")
              else:
                  final_lines.append(line)
          
          content = "\n".join(final_lines)
          
          print(">>> Writing fixed Dockerfile...")
          with open("Dockerfile", "w") as f:
              f.write(content)
              
          print(">>> Dockerfile fixed! Top 20 lines:")
          print(content[:1000])

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: false
