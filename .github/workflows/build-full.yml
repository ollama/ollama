name: Build Ollama (Fix Syntax and Copy Libs)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 清理空间 (保持之前的逻辑)
      - name: Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取代码 (浅克隆)
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main
          fetch-depth: 1

      # 3. 生成 Dockerfile (修复语法错误，移除注释)
      - name: Generate Fixed Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM nvidia/cuda:12.2.2-devel-ubuntu22.04 AS builder

          ENV GO_VERSION=1.22.8
          ARG CMAKE_VERSION=3.28.3
          
          WORKDIR /go/src/github.com/ollama/ollama
          COPY . .

          # 核心命令：安装依赖 -> 安装CMake/Go -> 编译Vulkan -> 编译CUDA -> 编译主程序
          # 注意：这里没有任何注释，防止语法错误
          RUN apt-get update && apt-get install -y --no-install-recommends curl git build-essential libvulkan-dev vulkan-tools libvulkan1 \
              && rm -rf /var/lib/apt/lists/* \
              && curl -L https://github.com/Kitware/CMake/releases/download/v\${CMAKE_VERSION}/cmake-\${CMAKE_VERSION}-linux-x86_64.tar.gz | tar -xz -C /usr/local --strip-components=1 \
              && curl -L https://go.dev/dl/go\${GO_VERSION}.linux-amd64.tar.gz | tar -xz -C /usr/local \
              && export PATH=\$PATH:/usr/local/go/bin \
              && cmake --preset 'Vulkan' \
              && cmake --build --parallel --preset 'Vulkan' \
              && cmake --install build --component Vulkan --strip \
              && cmake --preset 'CUDA 12' \
              && cmake --build --parallel --preset 'CUDA 12' \
              && cmake --install build --component CUDA --strip \
              && go generate ./... \
              && go build -trimpath -ldflags "-s -w" -o /bin/ollama .

          FROM ubuntu:22.04

          RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates libvulkan1 && rm -rf /var/lib/apt/lists/*

          COPY --from=builder /bin/ollama /bin/ollama
          COPY --from=builder /go/src/github.com/ollama/ollama/dist/lib/ollama /lib/ollama

          ENV OLLAMA_HOST=0.0.0.0:11434
          ENV OLLAMA_VULKAN=1
          ENV LD_LIBRARY_PATH=/lib/ollama
          
          EXPOSE 11434
          ENTRYPOINT ["/bin/ollama"]
          CMD ["serve"]
          EOF

      # 4. 登录
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 转小写用户名
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: true
