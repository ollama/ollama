name: Build Ollama (CUDA + Vulkan - Surgical Fix)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 强力清理磁盘 (CUDA + Vulkan 编译需要巨大空间，这步不能省)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取官方源码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【精准手术】保留 CUDA，剔除 ROCm
      # 使用 Python 脚本确保万无一失，解决 sed 匹配不到空格的问题
      - name: Patch Dockerfile with Python
        shell: python
        run: |
          import sys
          
          print("--- 开始修改 Dockerfile ---")
          lines = []
          with open("Dockerfile", "r") as f:
              lines = f.readlines()
          
          with open("Dockerfile", "w") as f:
              for line in lines:
                  # 1. 只要这一行试图从 rocm 阶段复制文件，就给它注释掉
                  # 这会切断依赖链，导致 Docker 直接跳过 base-amd64 阶段（那个报错的 yum）
                  # 无论是 "COPY --from=rocm" 还是 "COPY --from=rocm-6" 都会被命中
                  if "COPY --from=rocm" in line:
                      print(f"注释掉 ROCm 依赖: {line.strip()}")
                      f.write(f"# {line}")
                  
                  # 2. 找到最终的 Ubuntu 阶段，注入 Vulkan 环境变量
                  elif "FROM ubuntu:24.04 AS default" in line:
                      f.write(line)
                      f.write("ENV OLLAMA_VULKAN=1\n")
                      print("已注入 ENV OLLAMA_VULKAN=1")
                  
                  # 3. 其他行（包括 COPY --from=cuda ...）原样保留！
                  else:
                      f.write(line)
          
          print("--- 修改完成，正在检查 Dockerfile 关键部分 ---")
          
          # 打印出来让你确认 CUDA 还在，ROCm 没了
          with open("Dockerfile", "r") as f:
              content = f.read()
              if "COPY --from=cuda" in content:
                  print("✅ 确认：CUDA 依赖已保留")
              else:
                  print("❌ 警告：CUDA 依赖不见了！(不应该发生)")
                  
              if "# COPY --from=rocm" in content:
                  print("✅ 确认：ROCm 依赖已注释")
              else:
                  print("❌ 警告：ROCm 依赖未被注释！(可能导致编译失败)")

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          # 禁用缓存导出，防止磁盘爆满
          no-cache: false
