name: Build Ollama (Final Fix - Copy GPU Libs)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 强力清理磁盘 (必须保留，防止炸盘)
      - name: Maximize Disk Space
        run: |
          echo ">>> 清理前空间："
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo ">>> 清理后空间："
          df -h

      # 2. 拉取代码 (浅克隆)
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main
          fetch-depth: 1

      # 3. 生成 Dockerfile (修复了漏拷文件的 BUG)
      - name: Generate Fixed Dockerfile
        run: |
          cat <<EOF > Dockerfile
          # === 第一阶段：构建环境 ===
          # 使用 NVIDIA 官方开发镜像 (自带 CUDA 环境)
          FROM nvidia/cuda:11.8.0-devel-ubuntu22.04 AS builder

          ENV GO_VERSION=1.22.8
          
          # 安装构建依赖：Vulkan, CMake, Go, 基础工具
          RUN apt-get update && apt-get install -y --no-install-recommends \
              curl git cmake build-essential \
              libvulkan-dev vulkan-tools libvulkan1 \
              && rm -rf /var/lib/apt/lists/* \
              && curl -L https://go.dev/dl/go\${GO_VERSION}.linux-amd64.tar.gz -o go.tar.gz \
              && tar -C /usr/local -xzf go.tar.gz \
              && rm go.tar.gz

          ENV PATH=\$PATH:/usr/local/go/bin
          WORKDIR /go/src/github.com/ollama/ollama
          COPY . .

          # 【编译参数】
          # 1. 强制开启 Vulkan
          # 2. 因为环境里有 nvcc，CUDA 也会自动被检测并编译
          ENV OLLAMA_VULKAN=1
          ENV CGO_ENABLED=1

          # 【核心步骤】编译
          # go generate 会调用 CMake 编译 llama.cpp，并把结果放在 dist/ 目录下
          RUN go generate ./... && \
              go build -trimpath -ldflags "-s -w" -o /bin/ollama .

          # === 第二阶段：运行时环境 ===
          FROM ubuntu:22.04

          # 安装运行时依赖
          RUN apt-get update && apt-get install -y --no-install-recommends \
              ca-certificates \
              libvulkan1 \
              && rm -rf /var/lib/apt/lists/*

          # 1. 复制主程序
          COPY --from=builder /bin/ollama /bin/ollama
          
          # 【关键修复】复制编译好的 GPU 驱动库！
          # 上一个版本就是漏了这一行，导致只有 100MB
          COPY --from=builder /go/src/github.com/ollama/ollama/dist/lib/ollama /lib/ollama

          ENV OLLAMA_HOST=0.0.0.0:11434
          ENV OLLAMA_VULKAN=1
          # 将库路径加入加载列表，确保程序能找到
          ENV LD_LIBRARY_PATH=/lib/ollama:\$LD_LIBRARY_PATH
          
          EXPOSE 11434

          ENTRYPOINT ["/bin/ollama"]
          CMD ["serve"]
          EOF

          echo ">>> Dockerfile 生成完毕 (已包含 GPU Libs Copy)"

      # 4. 登录
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 转小写用户名
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: true
