name: Ollama Official + Vulkan

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Ollama
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      - name: Create Dockerfile
        run: |
          cat > Dockerfile << 'EOF'
          # 轻量级 Vulkan 编译阶段
          FROM ubuntu:24.04 AS vulkan-builder
          
          RUN apt-get update && \
              apt-get install -y git build-essential curl ccache wget gnupg && \
              wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | tee /etc/apt/trusted.gpg.d/lunarg.asc && \
              wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list https://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list && \
              apt-get update && apt-get install -y vulkan-sdk && \
              curl -fsSL "https://github.com/Kitware/CMake/releases/download/v3.28.3/cmake-3.28.3-linux-x86_64.tar.gz" | \
                tar xz -C /usr/local --strip-components=1
          
          WORKDIR /build
          COPY CMakeLists.txt CMakePresets.json ./
          COPY ml/backend/ggml/ggml ml/backend/ggml/ggml
          
          # 单线程编译避免超时
          RUN cmake --preset Vulkan -DOLLAMA_RUNNER_DIR="vulkan" && \
              cmake --build --preset Vulkan --parallel 1 && \
              cmake --install build --component Vulkan --strip
          
          # 最终镜像
          FROM ollama/ollama:latest
          
          RUN apt-get update && \
              apt-get install -y wget gnupg && \
              wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | tee /etc/apt/trusted.gpg.d/lunarg.asc && \
              wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list https://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list && \
              apt-get update && apt-get install -y libvulkan1 vulkan-tools && \
              rm -rf /var/lib/apt/lists/*
          
          COPY --from=vulkan-builder /build/dist/lib/ollama/vulkan /usr/lib/ollama/vulkan
          EOF

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        timeout-minutes: 180
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/ollama:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
