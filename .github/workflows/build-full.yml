name: Build Ollama (CUDA + Vulkan - No Broken ROCm)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 强力清理磁盘 (必须保留)
      - name: Free Disk Space (Manual)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取官方代码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【精准手术】保留 CUDA，切除坏掉的 ROCm
      - name: Patch Dockerfile
        run: |
          echo "正在修改 Dockerfile..."
          
          # === 关键修改：切除 ROCm ===
          # 原理：只要最终镜像不 COPY rocm，Docker 就根本不会去构建那个报错的 base-amd64 阶段
          # 我们把 COPY --from=rocm 注释掉，这样构建过程会直接跳过 yum install 错误
          
          # 处理官方 Dockerfile 可能的两种写法 (rocm 或 rocm-6)
          sed -i 's/^COPY --from=rocm/# COPY --from=rocm/' Dockerfile
          
          # === 关键保留：CUDA 和 Vulkan 都不动 ===
          # 我们不碰 COPY --from=cuda，所以 N 卡驱动会被完整保留
          
          # === 关键增强：强制开启 Vulkan ===
          # 确保你的 AMD 核显能跑
          sed -i '/FROM ubuntu:24.04 AS default/a ENV OLLAMA_VULKAN=1' Dockerfile
          
          echo "=== 检查修改后的 Dockerfile 末尾（确认 rocm 被注释）==="
          grep "COPY --from=" Dockerfile

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: false
