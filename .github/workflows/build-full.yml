name: Build Ollama (Nuclear Slim - Single Layer)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 【极限清理】腾出所有可能的空间
      - name: Maximize Disk Space
        run: |
          echo ">>> 清理前空间："
          df -h
          # 删除预装的大型软件
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          # 清理 Docker 现有镜像
          sudo docker image prune --all --force
          echo ">>> 清理后空间："
          df -h

      # 2. 拉取代码 (仅拉取最近一次提交，不拉取历史记录)
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main
          fetch-depth: 1  # 关键：浅克隆，节省空间

      # 3. 【生成单层极简 Dockerfile】
      - name: Generate Slim Dockerfile
        run: |
          cat <<EOF > Dockerfile
          # === 第一阶段：构建环境 ===
          # 使用 NVIDIA 官方开发镜像，自带 CUDA 12 编译器，无需额外下载巨大的 SDK
          FROM nvidia/cuda:12.2.2-devel-ubuntu22.04 AS builder

          # 设置 Go 版本
          ENV GO_VERSION=1.22.8

          # 【关键】将所有安装步骤合并为一层，避免中间层占用空间
          # 1. 安装基础工具 (curl, git, cmake, gcc)
          # 2. 安装 Vulkan 开发库 (为了 AMD 核显)
          # 3. 安装 Go 语言
          # 4. 清理 apt 缓存 (rm -rf /var/lib/apt/lists/*)
          RUN apt-get update && apt-get install -y --no-install-recommends \
              curl git cmake build-essential \
              libvulkan-dev vulkan-tools libvulkan1 \
              && rm -rf /var/lib/apt/lists/* \
              && curl -L https://go.dev/dl/go\${GO_VERSION}.linux-amd64.tar.gz -o go.tar.gz \
              && tar -C /usr/local -xzf go.tar.gz \
              && rm go.tar.gz

          ENV PATH=\$PATH:/usr/local/go/bin
          
          # 设置工作目录
          WORKDIR /go/src/github.com/ollama/ollama

          # 复制当前目录下的所有文件到容器
          COPY . .

          # 【关键】编译设置
          # 强制开启 Vulkan，同时因为身处 NVIDIA 容器，CUDA 会被自动编译
          ENV OLLAMA_VULKAN=1
          ENV CGO_ENABLED=1

          # 开始编译
          # generate 会编译 llama.cpp，这是最耗时和耗空间的一步
          # build 生成最终二进制
          RUN go generate ./... && \
              go build -trimpath -ldflags "-s -w" -o /bin/ollama .

          # === 第二阶段：运行时环境 (极小) ===
          FROM ubuntu:22.04

          # 安装运行时依赖 (只装必要的库，不装开发工具)
          # 包含 Vulkan Loader 和 CA 证书
          RUN apt-get update && apt-get install -y --no-install-recommends \
              ca-certificates \
              libvulkan1 \
              && rm -rf /var/lib/apt/lists/*

          # 仅从构建阶段复制编译好的二进制文件 (几百 MB)
          COPY --from=builder /bin/ollama /bin/ollama

          ENV OLLAMA_HOST=0.0.0.0:11434
          ENV OLLAMA_VULKAN=1
          EXPOSE 11434

          ENTRYPOINT ["/bin/ollama"]
          CMD ["serve"]
          EOF

          echo ">>> Dockerfile 生成完毕："
          cat Dockerfile

      # 4. 登录
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 转小写用户名
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          # 【生死攸关】禁用缓存！
          # 因为之前的缓存可能已经把硬盘占满了，这次我们完全不读写外部缓存，只靠本地瞬时空间
          no-cache: true
