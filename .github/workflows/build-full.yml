name: Build Ollama with CUDA 12 and Vulkan Support

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  OLLAMA_REPO: ollama/ollama

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
    steps:
      - name: Check for updates
        id: check
        run: |
          LATEST_SHA=$(curl -s https://api.github.com/repos/${{ env.OLLAMA_REPO }}/commits/main | jq -r '.sha')
          echo "Latest commit: $LATEST_SHA"
          
          IMAGE_EXISTS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/${{ github.repository_owner }}/ollama/manifests/$LATEST_SHA" \
            -o /dev/null -w "%{http_code}")
          
          if [ "$IMAGE_EXISTS" = "200" ]; then
            echo "Image already exists for commit $LATEST_SHA"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "New commit found, will build"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "commit_sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout Ollama Source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.OLLAMA_REPO }}
          ref: main
          fetch-depth: 1

      - name: Generate Dockerfile
        run: |
          cat > Dockerfile << 'DOCKERFILE'
          FROM nvidia/cuda:12.6.3-devel-ubuntu22.04 AS builder
          
          ARG GO_VERSION=1.23.4
          ARG CMAKE_VERSION=3.28.3
          
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PATH=/usr/local/go/bin:$PATH
          
          WORKDIR /build
          
          # å®‰è£…åŸºç¡€ä¾èµ–å’Œ Vulkan SDK
          RUN apt-get update && \
              apt-get install -y --no-install-recommends \
                ca-certificates \
                curl \
                git \
                build-essential \
                wget \
                pkg-config \
                make \
                gnupg \
                software-properties-common \
                rsync && \
              wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | tee /etc/apt/trusted.gpg.d/lunarg.asc && \
              wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list && \
              apt-get update && \
              apt-get install -y --no-install-recommends vulkan-sdk && \
              rm -rf /var/lib/apt/lists/*
          
          # é…ç½® git (make sync éœ€è¦)
          RUN git config --global user.email "builder@ollama.local" && \
              git config --global user.name "Ollama Builder"
          
          # å®‰è£… CMake
          RUN curl -L "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-x86_64.tar.gz" | \
              tar -xz -C /usr/local --strip-components=1
          
          # å®‰è£… Go
          RUN curl -L "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" | \
              tar -xz -C /usr/local
          
          # å¤åˆ¶æºä»£ç 
          COPY . .
          
          # åŒæ­¥ä¾èµ– (å…³é”®æ­¥éª¤!)
          RUN make -f Makefile.sync clean sync
          
          # ç¼–è¯‘ CPU åº“ (åŸºç¡€åº“)
          RUN cmake --preset CPU && \
              cmake --build --parallel --preset CPU && \
              cmake --install build --component CPU --strip
          
          # ç¼–è¯‘ Vulkan åŽç«¯
          RUN cmake --preset Vulkan && \
              cmake --build --parallel --preset Vulkan && \
              cmake --install build --component Vulkan --strip
          
          # ç¼–è¯‘ CUDA 12 åŽç«¯
          RUN cmake --preset 'CUDA 12' && \
              cmake --build --parallel --preset 'CUDA 12' && \
              cmake --install build --component CUDA --strip
          
          # ç¼–è¯‘ Ollama ä¸»ç¨‹åº
          RUN go generate ./... && \
              go build -trimpath -ldflags "-s -w" -o /build/bin/ollama .
          
          # æœ€ç»ˆè¿è¡Œé•œåƒ
          FROM ubuntu:22.04
          
          ENV DEBIAN_FRONTEND=noninteractive
          
          # å®‰è£…è¿è¡Œæ—¶ä¾èµ–
          RUN apt-get update && \
              apt-get install -y --no-install-recommends \
                ca-certificates \
                gnupg \
                software-properties-common \
                wget && \
              wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | tee /etc/apt/trusted.gpg.d/lunarg.asc && \
              wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list && \
              apt-get update && \
              apt-get install -y --no-install-recommends \
                libvulkan1 \
                vulkan-tools && \
              rm -rf /var/lib/apt/lists/*
          
          # å¤åˆ¶ç¼–è¯‘å¥½çš„æ–‡ä»¶
          COPY --from=builder /build/bin/ollama /bin/ollama
          COPY --from=builder /build/dist/lib/ollama /lib/ollama
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          ENV OLLAMA_HOST=0.0.0.0:11434
          ENV LD_LIBRARY_PATH=/lib/ollama
          
          EXPOSE 11434
          
          ENTRYPOINT ["/bin/ollama"]
          CMD ["serve"]
          DOCKERFILE

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> ${GITHUB_ENV}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.check-updates.outputs.commit_sha || github.sha }}
            type=raw,value={{date 'YYYYMMDD'}}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Release Summary
        run: |
          echo "## ðŸŽ‰ æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ needs.check-updates.outputs.commit_sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ é•œåƒæ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ä½¿ç”¨ NVIDIA GPU (CUDA 12)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --gpus all \\" >> $GITHUB_STEP_SUMMARY
          echo "  -v ollama:/root/.ollama \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 11434:11434 \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name ollama \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ä½¿ç”¨ AMD/Intel æ ¸æ˜¾ (Vulkan)" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d \\" >> $GITHUB_STEP_SUMMARY
          echo "  --device=/dev/dri \\" >> $GITHUB_STEP_SUMMARY
          echo "  -v ollama:/root/.ollama \\" >> $GITHUB_STEP_SUMMARY
          echo "  -p 11434:11434 \\" >> $GITHUB_STEP_SUMMARY
          echo "  -e OLLAMA_VULKAN=1 \\" >> $GITHUB_STEP_SUMMARY
          echo "  --name ollama \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ éªŒè¯ GPU åŠ é€Ÿ" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# è¿›å…¥å®¹å™¨" >> $GITHUB_STEP_SUMMARY
          echo "docker exec -it ollama bash" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æŸ¥çœ‹ Vulkan è®¾å¤‡ (AMD/Intel)" >> $GITHUB_STEP_SUMMARY
          echo "vulkaninfo --summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# è¿è¡Œæ¨¡åž‹æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "ollama run llama3.2:1b" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æ³¨æ„äº‹é¡¹" >> $GITHUB_STEP_SUMMARY
          echo "- Vulkan æ”¯æŒç›®å‰æ˜¯**å®žéªŒæ€§åŠŸèƒ½**" >> $GITHUB_STEP_SUMMARY
          echo "- å¿…é¡»è®¾ç½® \`OLLAMA_VULKAN=1\` çŽ¯å¢ƒå˜é‡æ‰èƒ½å¯ç”¨ Vulkan" >> $GITHUB_STEP_SUMMARY
          echo "- AMD GPU éœ€è¦å®‰è£… AMDGPU é©±åŠ¨æˆ– Mesa Vulkan é©±åŠ¨" >> $GITHUB_STEP_SUMMARY
          echo "- æŸäº›æ¨¡åž‹å¯èƒ½åœ¨ Vulkan åŽç«¯é‡åˆ°å…¼å®¹æ€§é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "- å¯ç”¨ \`GGML_VK_VISIBLE_DEVICES\` çŽ¯å¢ƒå˜é‡é€‰æ‹©ç‰¹å®š GPU" >> $GITHUB_STEP_SUMMARY
