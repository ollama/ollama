name: Build Official Ollama (Bypass Broken ROCm Only)

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  USERNAME: ${{ github.actor }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 必须清理磁盘 (官方构建非常占空间)
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      # 2. 拉取官方源码
      - name: Checkout Official Upstream
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main

      # 3. 【核心修正】只修改 Dockerfile 的引用，不改基础镜像
      # 逻辑：
      # 读取官方 Dockerfile，找到所有 "COPY --from=rocm" 的行，加上 # 注释。
      # 这样 Docker 构建引擎发现最终产物不需要 ROCm，就会自动跳过那个报错的 base-amd64 阶段。
      # 剩下的 CUDA、Vulkan、CPU 全部保留官方原样。
      - name: Modify Dockerfile
        shell: python
        run: |
          print("正在处理 Dockerfile...")
          
          with open("Dockerfile", "r") as f:
              lines = f.readlines()
          
          new_lines = []
          rocm_cut_count = 0
          
          for line in lines:
              # 1. 检测是否是复制 ROCm 文件的行 (忽略空格)
              if "COPY --from=rocm" in line:
                  # 注释掉这一行
                  new_lines.append(f"# {line}")
                  rocm_cut_count += 1
                  print(f"已屏蔽 ROCm 依赖: {line.strip()}")
              
              # 2. 检测最终阶段，注入 Vulkan 环境变量
              elif "FROM ubuntu:24.04 AS default" in line:
                  new_lines.append(line)
                  new_lines.append("ENV OLLAMA_VULKAN=1\n")
                  print("已注入 ENV OLLAMA_VULKAN=1")
              
              # 3. 其他行完全保留 (包括 CUDA)
              else:
                  new_lines.append(line)
          
          if rocm_cut_count == 0:
              print("❌ 错误：没有找到 ROCm 相关的行，脚本可能失效！")
              exit(1)
              
          with open("Dockerfile", "w") as f:
              f.writelines(new_lines)
              
          print(f"✅ 处理完成，共屏蔽了 {rocm_cut_count} 处 ROCm 依赖。")

      # 4. 登录 GitHub 镜像库
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. 设置 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 用户名转小写
      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${USERNAME,,}" >> ${GITHUB_ENV}

      # 7. 编译并推送
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/ollama:latest
          platforms: linux/amd64
          no-cache: false
