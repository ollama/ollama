name: Build Ollama Vulkan Only

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Free Up Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo docker system prune -af --volumes
          df -h

      - name: Checkout Ollama Source
        uses: actions/checkout@v4
        with:
          repository: ollama/ollama
          ref: main
          fetch-depth: 1

      - name: Create Python Script to Modify Dockerfile
        run: |
          cat > modify_dockerfile.py << 'EOF'
          import re
          
          with open('Dockerfile', 'r') as f:
              lines = f.readlines()
          
          output = []
          skip_until_next_from = False
          in_base_amd64 = False
          
          for i, line in enumerate(lines):
              # 1. æ›¿æ¢ ROCm base ä¸º Ubuntu
              if 'FROM --platform=linux/amd64 rocm/dev-almalinux-8' in line and 'AS base-amd64' in line:
                  output.append('FROM --platform=linux/amd64 ubuntu:24.04 AS base-amd64\n')
                  in_base_amd64 = True
                  continue
              
              # åœ¨ base-amd64 é˜¶æ®µï¼Œè·³è¿‡ ROCm ç›¸å…³çš„ RUN å‘½ä»¤ï¼Œæ›¿æ¢ä¸ºç®€å•å®‰è£…
              if in_base_amd64:
                  if line.startswith('RUN yum'):
                      # è·³è¿‡æ•´ä¸ª yum å®‰è£…å—
                      j = i
                      while j < len(lines) and not lines[j].startswith('FROM'):
                          if 'cuda-rhel8.repo' in lines[j]:
                              break
                          j += 1
                      # æ·»åŠ æ›¿æ¢çš„ç®€å•å®‰è£…
                      output.append('RUN apt-get update && apt-get install -y git build-essential curl ca-certificates && rm -rf /var/lib/apt/lists/*\n')
                      # è·³åˆ° yum å—ç»“æŸ
                      for k in range(i, j+1):
                          lines[k] = ''  # æ ‡è®°ä¸ºå·²å¤„ç†
                      continue
                  elif line.startswith('ENV PATH=') and 'gcc-toolset' in line:
                      continue  # è·³è¿‡ ROCm ç‰¹å®šçš„ ENV
                  elif line.startswith('FROM'):
                      in_base_amd64 = False
              
              # 2. å°† CUDA æž„å»ºé˜¶æ®µæ›¿æ¢ä¸º scratch
              if 'FROM' in line and 'nvidia/cuda' in line and ('AS cuda-12' in line or 'AS cuda-13' in line):
                  stage_name = line.split('AS')[1].strip()
                  output.append(f'FROM scratch AS {stage_name}\n')
                  skip_until_next_from = True
                  continue
              
              # 3. å°† ROCm æž„å»ºé˜¶æ®µæ›¿æ¢ä¸º scratch
              if 'FROM' in line and 'AS rocm-6' in line:
                  output.append('FROM scratch AS rocm-6\n')
                  skip_until_next_from = True
                  continue
              
              # 4. å°† JetPack é˜¶æ®µæ›¿æ¢ä¸º scratch
              if 'FROM' in line and 'jetpack' in line and ('AS jetpack-5' in line or 'AS jetpack-6' in line):
                  stage_name = line.split('AS')[1].strip()
                  output.append(f'FROM scratch AS {stage_name}\n')
                  skip_until_next_from = True
                  continue
              
              # è·³è¿‡è¢«æ›¿æ¢ä¸º scratch çš„é˜¶æ®µçš„æ‰€æœ‰å†…å®¹
              if skip_until_next_from:
                  if line.startswith('FROM'):
                      skip_until_next_from = False
                  else:
                      continue
              
              # 5. æ³¨é‡ŠæŽ‰ CUDA COPY
              if line.startswith('COPY --from=cuda-12') or line.startswith('COPY --from=cuda-13'):
                  output.append('# ' + line)
                  continue
              
              # 6. æ³¨é‡ŠæŽ‰ JetPack COPY
              if line.startswith('COPY --from=jetpack-5') or line.startswith('COPY --from=jetpack-6'):
                  output.append('# ' + line)
                  continue
              
              # 7. æ³¨é‡ŠæŽ‰ ROCm COPY
              if line.startswith('COPY --from=rocm-6'):
                  output.append('# ' + line)
                  continue
              
              # ä¿ç•™å…¶ä»–æ‰€æœ‰è¡Œ
              if line:  # åªæ·»åŠ éžç©ºè¡Œ
                  output.append(line)
          
          with open('Dockerfile', 'w') as f:
              f.writelines(output)
          
          print("=== Dockerfile ä¿®æ”¹å®Œæˆ ===")
          EOF

      - name: Run Python Script
        run: python3 modify_dockerfile.py

      - name: Verify Modifications
        run: |
          echo "=== base-amd64 ==="
          grep -A 3 "AS base-amd64" Dockerfile
          
          echo "=== cuda-12 ==="
          grep -A 1 "AS cuda-12" Dockerfile
          
          echo "=== amd64 stage ==="
          sed -n '/FROM.*scratch AS amd64/,/^FROM/p' Dockerfile | head -10

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase Username
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama-vulkan
          tags: |
            type=raw,value=latest
            type=raw,value={{date 'YYYYMMDD'}}

      - name: Build and Push
        uses: docker/build-push-action@v5
        timeout-minutes: 240
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama-vulkan:latest\`" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker run -d --device=/dev/dri --device=/dev/kfd -v ollama:/root/.ollama -p 11434:11434 -e OLLAMA_VULKAN=1 --name ollama ${{ env.REGISTRY }}/${{ env.OWNER_LC }}/ollama-vulkan:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Dockerfile
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: modified-dockerfile
          path: Dockerfile
