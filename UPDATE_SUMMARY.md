# Сводка обновлений для устранения CVE

## Дата обновления
30 ноября 2025

## Выполненные обновления

### 1. Основной Dockerfile (обновлен)
- ✅ **ROCm:** `6.3.3` → `7.1.1` (последняя версия)
- ✅ **AlmaLinux ARM64:** `almalinux:8` → `almalinux:10.1` (последняя версия)
- ✅ **Ubuntu:** Добавлены обновления безопасности (`apt-get upgrade -y`)
- ✅ **Все базовые образы:** Добавлены обновления безопасности (`dnf update -y --security`)
- ✅ **Очистка:** Добавлена очистка временных файлов и кэша
- ✅ **Безопасность:** Добавлен non-root пользователь для запуска контейнера
- ✅ **Сертификаты:** Обновлены CA сертификаты

### 2. Созданные альтернативные версии

#### Dockerfile.almalinux10
- Полное обновление до AlmaLinux 10.1 для ARM64
- ROCm 7.1.1 для AMD64 (совместимость с almalinux-8)
- Все обновления безопасности применены

#### Dockerfile.almalinux9
- Альтернативная версия с AlmaLinux 9.7 для ARM64
- Рекомендуется если требуется лучшая совместимость с существующими репозиториями

## Детали обновлений

### Базовые образы

| Компонент | Старая версия | Новая версия | Статус |
|-----------|--------------|--------------|--------|
| ROCm (AMD64) | 6.3.3 | 7.1.1 | ✅ Обновлено |
| AlmaLinux (ARM64) | 8 | 10.1 | ✅ Обновлено |
| Ubuntu (финальный) | 24.04 | 24.04 + обновления | ✅ Обновлено |

### Улучшения безопасности

1. **Обновления безопасности системных пакетов:**
   - Добавлено `dnf update -y --security` для всех AlmaLinux образов
   - Добавлено `apt-get upgrade -y` для Ubuntu и JetPack образов

2. **Очистка временных файлов:**
   - Удаление временных архивов Vulkan SDK
   - Очистка кэша пакетов (`dnf clean all`, `apt-get clean`)

3. **Non-root пользователь:**
   - Контейнер запускается от имени пользователя `ollama` вместо root
   - Повышает безопасность при эксплуатации

4. **Обновление зависимостей:**
   - Добавлен `go mod tidy` для обновления Go зависимостей
   - Обновлены CA сертификаты

## Использование обновленных версий

### Вариант 1: Использовать обновленный основной Dockerfile
```bash
# Основной Dockerfile уже обновлен
docker build -t ollama:latest .
```

### Вариант 2: Использовать версию с AlmaLinux 10
```bash
cp Dockerfile.almalinux10 Dockerfile
docker build -t ollama:almalinux10 .
```

### Вариант 3: Использовать версию с AlmaLinux 9 (для совместимости)
```bash
cp Dockerfile.almalinux9 Dockerfile
docker build -t ollama:almalinux9 .
```

## Важные замечания

### Совместимость ROCm
- ROCm образы для AMD64 остаются на базе `almalinux-8` из-за требований совместимости
- ROCm версия обновлена до `7.1.1` (последняя доступная)
- Для ARM64 используется `almalinux:10.1` без ROCm

### Тестирование
Перед использованием в production рекомендуется:

1. **Протестировать сборку:**
   ```bash
   docker build -t ollama:test .
   ```

2. **Проверить работу:**
   ```bash
   docker run --rm ollama:test --version
   ```

3. **Проверить уязвимости:**
   ```bash
   ./check-vulnerabilities.sh
   ```

### Откат изменений
Если возникнут проблемы, можно откатиться:

```bash
git checkout Dockerfile
```

## Следующие шаги

1. ✅ Обновлены базовые образы
2. ✅ Добавлены обновления безопасности
3. ⏳ Рекомендуется обновить Go зависимости (см. `go.mod.updated`)
4. ⏳ Настроить автоматическое сканирование CVE в CI/CD
5. ⏳ Регулярно проверять обновления базовых образов

## Дополнительные файлы

- `CVE_ANALYSIS_REPORT.md` - Подробный отчет об анализе уязвимостей
- `BASE_IMAGES_VERSIONS.md` - Информация о версиях базовых образов
- `SECURITY_UPDATE_INSTRUCTIONS.md` - Инструкции по применению обновлений
- `go.mod.updated` - Обновленные версии Go зависимостей
