# Dockerfile.dev - build rápido sólo del binario ollama para hot-swap
FROM golang:1.24-bookworm AS build
WORKDIR /src
# Evitar descargar módulos repetidamente si no cambian
COPY go.mod go.sum ./
RUN go mod download
COPY . .
ENV CGO_ENABLED=1 GOOS=linux GOARCH=amd64 GOTOOLCHAIN=auto
# Intentar primero cmd/ollama y luego fallback a raíz
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg/mod \
    (go build -o /ollama-dev ./cmd/ollama || go build -o /ollama-dev .)

FROM scratch AS artifact
COPY --from=build /ollama-dev /ollama-dev
# Esta imagen sólo sirve para extraer /ollama-dev
